SQL> /*
SQL> -- 1. Charger l'application bancaire (AppliBank.sql)
SQL> -- dans le sch?ma de l'utilisateur TUNINGDB
SQL> -- D?j? fait dans ...start.sql
SQL> -- Les index actuels sur l'application
SQL> -- Pour l'instant seul les 3 indexes primary doivent exister
SQL> select table_name, column_name, index_name
SQL> from user_ind_columns
SQL> where table_name in ('CLIENT', 'COMPTE', 'TRANSACTION')
SQL> order by table_name, index_name, column_name;
SQL> */
SQL> -- v?rification du type d'optimiseur
SQL> show parameter optimizer_mode;

NAME                                 TYPE        VALUE                          
------------------------------------ ----------- ------------------------------ 
optimizer_mode                       string      ALL_ROWS                       
SQL> -- optimizer_mode string ALL_ROWS
SQL> -- passer en mode all_rows si utile
SQL> set autotrace off
SQL> alter session set optimizer_mode=all_rows ;

Session modifiée.

SQL> -- calculer les statistiques sur les objets de l'utilisateur
SQL> -- &MYPDBUSER
SQL> execute dbms_stats.gather_schema_stats('&MYPDBUSER');

Procédure PL/SQL terminée avec succès.

SQL> -- Connexion avec au niveau CDB pour prendre un clich? AWR.
SQL> -- La gestion des statistiques se fait au niveau e ma CDB
SQL> connect &MYCDBUSER@&DBALIASCDB/&MYCDBUSERPASS
Connecté.
SQL> -- Prendre un premier clich? AWR pour d?limiter
SQL> -- l'espace de r?cup?ration des requ?tes.
SQL> set serveroutput on
SQL> variable snapid1 number;
SQL> begin
  2  :snapid1 := dbms_workload_repository.create_snapshot;
  3  dbms_output.put_line('snap_id1='||:snapid1);
  4  end;
  5  /
snap_id1=1194                                                                   

Procédure PL/SQL terminée avec succès.

SQL> -- ReConnexion ? la PDB pour utiliser STA
SQL> connect &MYPDBUSER@&DBALIASPDB/&MYPDBUSERPASS
Connecté.
SQL> -- reporter le num?ro de clich? rendu par le programme ici :
SQL> -- snap_id1=153 ? snap_id1=743
SQL> -- 2. Provoquer de l'activit? (requ?tes sur l'application bancaire)
SQL> -- dans la base entre deux clich?s AWR
SQL> -- D?sactiver l'affichage ? l'?cran des r?sultats des requ?tes.
SQL> set autotrace &TRACEOPTION
SQL> /*
SQL> col compteid format a24
SQL> col nom format a20
SQL> col prenom format a20
SQL> col ville format a20
SQL> col adresse format a30
SQL> */
SQL> -- Lancement de plusieurs requ?tes
SQL> -- REQUETES 1 TABLE
SQL> -- Compter le nombre d'immatriculations
SQL> select count(*) from immatriculation;


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 3135058194                                                     
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
| Id  | Operation             | Name                 | Rows  | Cost (%CPU)| Time
     |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
|   0 | SELECT STATEMENT      |                      |     1 |  1086   (2)| 00:0
0:01 |                                                                          
                                                                                
|   1 |  SORT AGGREGATE       |                      |     1 |            |     
     |                                                                          
                                                                                
|   2 |   INDEX FAST FULL SCAN| PK_IMMATRICULATIONID |  1047K|  1086   (2)| 00:0
0:01 |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                


Statistiques
----------------------------------------------------------                      
          1  recursive calls                                                    
          0  db block gets                                                      
       4037  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
        563  bytes sent via SQL*Net to client                                   
        398  bytes received via SQL*Net from client                             
          2  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
          1  rows processed                                                     

SQL> -- SÃ©lectionner tous les vÃ©hicules bleus du catalogue
SQL> select * from catalogue
  2  WHERE couleur = 'bleu';

53 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 2124023629                                                     
                                                                                
------------------------------------------------------------------------------- 
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     | 
------------------------------------------------------------------------------- 
|   0 | SELECT STATEMENT  |           |    53 |  2809 |     3   (0)| 00:00:01 | 
|*  1 |  TABLE ACCESS FULL| CATALOGUE |    53 |  2809 |     3   (0)| 00:00:01 | 
------------------------------------------------------------------------------- 
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - filter("COULEUR"='bleu')                                                 


Statistiques
----------------------------------------------------------                      
         69  recursive calls                                                    
          0  db block gets                                                      
         53  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
       3448  bytes sent via SQL*Net to client                                   
        441  bytes received via SQL*Net from client                             
          5  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
         53  rows processed                                                     

SQL> -- SÃ©lectionner les clients de plus de 50 ans
SQL> select * from client
  2  WHERE age > 50;

15120 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 3057461031                                                     
                                                                                
----------------------------------------------------------------------------    
| Id  | Operation         | Name   | Rows  | Bytes | Cost (%CPU)| Time     |    
----------------------------------------------------------------------------    
|   0 | SELECT STATEMENT  |        | 15120 |   664K|   103   (1)| 00:00:01 |    
|*  1 |  TABLE ACCESS FULL| CLIENT | 15120 |   664K|   103   (1)| 00:00:01 |    
----------------------------------------------------------------------------    
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - filter("AGE">50)                                                         


Statistiques
----------------------------------------------------------                      
         44  recursive calls                                                    
          0  db block gets                                                      
       1354  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
     759739  bytes sent via SQL*Net to client                                   
      11474  bytes received via SQL*Net from client                             
       1009  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
      15120  rows processed                                                     

SQL> -- SÃ©lectionner l'Ã¢ge et le sexe des personnes qui souhaitent s'acheter une deuxiÃ¨me voiture
SQL> select age, sexe from marketing
  2  WHERE deuxiemeVoiture = 'true';


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 1777669847                                                     
                                                                                
------------------------------------------------------------------------------- 
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     | 
------------------------------------------------------------------------------- 
|   0 | SELECT STATEMENT  |           |     1 |    11 |     3   (0)| 00:00:01 | 
|*  1 |  TABLE ACCESS FULL| MARKETING |     1 |    11 |     3   (0)| 00:00:01 | 
------------------------------------------------------------------------------- 
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - filter("DEUXIEMEVOITURE"='true')                                         


Statistiques
----------------------------------------------------------                      
         25  recursive calls                                                    
          0  db block gets                                                      
         21  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
        631  bytes sent via SQL*Net to client                                   
        424  bytes received via SQL*Net from client                             
          2  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
          1  rows processed                                                     

SQL> -- SÃ©lectionner le nom et le numÃ©ro d'immatriculation des voitures de la marque Audi
SQL> select nom, immatriculation from immatriculation
  2  WHERE marque = 'Audi';

153499 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 1374169303                                                     
                                                                                
--------------------------------------------------------------------------------
-----                                                                           
                                                                                
| Id  | Operation         | Name            | Rows  | Bytes | Cost (%CPU)| Time 
    |                                                                           
                                                                                
--------------------------------------------------------------------------------
-----                                                                           
                                                                                
|   0 | SELECT STATEMENT  |                 |   153K|  4197K|  2725   (1)| 00:00
:01 |                                                                           
                                                                                
|*  1 |  TABLE ACCESS FULL| IMMATRICULATION |   153K|  4197K|  2725   (1)| 00:00
:01 |                                                                           
                                                                                
--------------------------------------------------------------------------------
-----                                                                           
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - filter("MARQUE"='Audi')                                                  


Statistiques
----------------------------------------------------------                      
         18  recursive calls                                                    
          0  db block gets                                                      
      19867  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
    4469409  bytes sent via SQL*Net to client                                   
     112995  bytes received via SQL*Net from client                             
      10235  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
     153499  rows processed                                                     

SQL> 
SQL> -- REQUETES 2 TABLES
SQL> -- SÃ©lectionner les vÃ©hicules du catalogue qui ont dÃ©jÃ  Ã©tÃ© immatriculÃ©s en tant que vÃ©hicules d'occasion
SQL> SELECT *
  2  FROM catalogue
  3  JOIN immatriculation
  4  ON catalogue.marque = immatriculation.marque
  5  WHERE immatriculation.occasion = 'VRAI';

6543780 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 1850348159                                                     
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
| Id  | Operation          | Name            | Rows  | Bytes | Cost (%CPU)| Time
     |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
|   0 | SELECT STATEMENT   |                 |  6443K|   700M|  2787   (3)| 00:0
0:01 |                                                                          
                                                                                
|*  1 |  HASH JOIN         |                 |  6443K|   700M|  2787   (3)| 00:0
0:01 |                                                                          
                                                                                
|   2 |   TABLE ACCESS FULL| CATALOGUE       |   265 | 14045 |     3   (0)| 00:0
0:01 |                                                                          
                                                                                
|*  3 |   TABLE ACCESS FULL| IMMATRICULATION |   327K|    19M|  2736   (2)| 00:0
0:01 |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - access("CATALOGUE"."MARQUE"="IMMATRICULATION"."MARQUE")                  
   3 - filter("IMMATRICULATION"."OCCASION"='VRAI')                              


Statistiques
----------------------------------------------------------                      
        124  recursive calls                                                    
          0  db block gets                                                      
      56608  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
  219152838  bytes sent via SQL*Net to client                                   
    4799252  bytes received via SQL*Net from client                             
     436253  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
    6543780  rows processed                                                     

SQL> -- SÃ©lectionner les clients qui ont le mÃªme taux que les potentiels client qui veulent acheter une deuxiÃ¨me voiture
SQL> SELECT *
  2  FROM client
  3  JOIN marketing
  4  ON client.taux = marketing.taux
  5  WHERE marketing.deuxiemeVoiture = 'true';

46 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 1338212028                                                     
                                                                                
--------------------------------------------------------------------------------
| Id  | Operation          | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------------
|   0 | SELECT STATEMENT   |           |    58 |  4466 |   107   (2)| 00:00:01 |
|*  1 |  HASH JOIN         |           |    58 |  4466 |   107   (2)| 00:00:01 |
|*  2 |   TABLE ACCESS FULL| MARKETING |     1 |    32 |     3   (0)| 00:00:01 |
|   3 |   TABLE ACCESS FULL| CLIENT    | 43596 |  1915K|   103   (1)| 00:00:01 |
--------------------------------------------------------------------------------
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - access("CLIENT"."TAUX"="MARKETING"."TAUX")                               
   2 - filter("MARKETING"."DEUXIEMEVOITURE"='true')                             


Statistiques
----------------------------------------------------------                      
         78  recursive calls                                                    
          0  db block gets                                                      
        355  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
       3955  bytes sent via SQL*Net to client                                   
        503  bytes received via SQL*Net from client                             
          5  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
         46  rows processed                                                     

SQL> -- SÃ©lectionner les clients qui ont dÃ©jÃ  possÃ©dÃ© une Audi
SQL> SELECT *
  2  FROM client
  3  JOIN immatriculation
  4  ON client.immatriculation = immatriculation.immatriculation
  5  WHERE immatriculation.marque = 'Audi';

11461 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 2362199741                                                     
                                                                                
--------------------------------------------------------------------------------
--------------                                                                  
                                                                                
| Id  | Operation          | Name            | Rows  | Bytes |TempSpc| Cost (%CP
U)| Time     |                                                                  
                                                                                
--------------------------------------------------------------------------------
--------------                                                                  
                                                                                
|   0 | SELECT STATEMENT   |                 | 43596 |  4512K|       |  3481   (
1)| 00:00:01 |                                                                  
                                                                                
|*  1 |  HASH JOIN         |                 | 43596 |  4512K|  2432K|  3481   (
1)| 00:00:01 |                                                                  
                                                                                
|   2 |   TABLE ACCESS FULL| CLIENT          | 43596 |  1915K|       |   103   (
1)| 00:00:01 |                                                                  
                                                                                
|*  3 |   TABLE ACCESS FULL| IMMATRICULATION |   153K|  9143K|       |  2726   (
1)| 00:00:01 |                                                                  
                                                                                
--------------------------------------------------------------------------------
--------------                                                                  
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - access("CLIENT"."IMMATRICULATION"="IMMATRICULATION"."IMMATRICULATION")   
   3 - filter("IMMATRICULATION"."MARQUE"='Audi')                                
                                                                                
Note                                                                            
-----                                                                           
   - this is an adaptive plan                                                   


Statistiques
----------------------------------------------------------                      
         92  recursive calls                                                    
          0  db block gets                                                      
      10831  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
     791134  bytes sent via SQL*Net to client                                   
       8905  bytes received via SQL*Net from client                             
        766  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
      11461  rows processed                                                     

SQL> -- SÃ©lectionner la couleur des voitures vendues Ã  des femmes
SQL> SELECT couleur
  2  FROM immatriculation
  3  JOIN client
  4  ON immatriculation.immatriculation = client.immatriculation
  5  WHERE client.sexe = 'F';

13138 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 2362199741                                                     
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
| Id  | Operation          | Name            | Rows  | Bytes | Cost (%CPU)| Time
     |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
|   0 | SELECT STATEMENT   |                 | 13138 |   384K|  2841   (2)| 00:0
0:01 |                                                                          
                                                                                
|*  1 |  HASH JOIN         |                 | 13138 |   384K|  2841   (2)| 00:0
0:01 |                                                                          
                                                                                
|*  2 |   TABLE ACCESS FULL| CLIENT          | 13138 |   166K|   103   (1)| 00:0
0:01 |                                                                          
                                                                                
|   3 |   TABLE ACCESS FULL| IMMATRICULATION |  1047K|    16M|  2730   (2)| 00:0
0:01 |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - access("IMMATRICULATION"."IMMATRICULATION"="CLIENT"."IMMATRICULATION")   
   2 - filter("CLIENT"."SEXE"='F')                                              
                                                                                
Note                                                                            
-----                                                                           
   - this is an adaptive plan                                                   


Statistiques
----------------------------------------------------------                      
         15  recursive calls                                                    
          0  db block gets                                                      
      10920  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
     290042  bytes sent via SQL*Net to client                                   
      10118  bytes received via SQL*Net from client                             
        877  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
      13138  rows processed                                                     

SQL> -- SÃ©lectionner le numÃ©ro d'immatriculation des voitures dont le modÃ¨le est Laguna 2.0T
SQL> SELECT immatriculation
  2  FROM immatriculation
  3  JOIN catalogue
  4  ON catalogue.nom = immatriculation.nom
  5  WHERE catalogue.nom='Laguna 2.0T';

399230 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 1850348159                                                     
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
| Id  | Operation          | Name            | Rows  | Bytes | Cost (%CPU)| Time
     |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
|   0 | SELECT STATEMENT   |                 |   399K|    12M|  2732   (1)| 00:0
0:01 |                                                                          
                                                                                
|*  1 |  HASH JOIN         |                 |   399K|    12M|  2732   (1)| 00:0
0:01 |                                                                          
                                                                                
|*  2 |   TABLE ACCESS FULL| CATALOGUE       |    10 |   110 |     3   (0)| 00:0
0:01 |                                                                          
                                                                                
|*  3 |   TABLE ACCESS FULL| IMMATRICULATION | 39923 |   818K|  2726   (1)| 00:0
0:01 |                                                                          
                                                                                
--------------------------------------------------------------------------------
------                                                                          
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   1 - access("CATALOGUE"."NOM"="IMMATRICULATION"."NOM")                        
   2 - filter("CATALOGUE"."NOM"='Laguna 2.0T')                                  
   3 - filter("IMMATRICULATION"."NOM"='Laguna 2.0T')                            


Statistiques
----------------------------------------------------------                      
         19  recursive calls                                                    
          0  db block gets                                                      
      14078  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
    7514896  bytes sent via SQL*Net to client                                   
     293258  bytes received via SQL*Net from client                             
      26617  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
     399230  rows processed                                                     

SQL> 
SQL> -- REQUETES 3 TABLES
SQL> -- SÃ©lectionner le taux des potentiels clients qui ont le mÃªme taux que les hommes ayant achetÃ© une Audi
SQL> SELECT DISTINCT marketing.taux
  2  FROM marketing
  3  JOIN client
  4  ON client.sexe = marketing.sexe
  5  JOIN immatriculation
  6  ON immatriculation.immatriculation = client.immatriculation
  7  WHERE immatriculation.marque = 'Audi' AND marketing.sexe='M';


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 376392015                                                      
                                                                                
--------------------------------------------------------------------------------
--------                                                                        
                                                                                
| Id  | Operation            | Name            | Rows  | Bytes | Cost (%CPU)| Ti
me     |                                                                        
                                                                                
--------------------------------------------------------------------------------
--------                                                                        
                                                                                
|   0 | SELECT STATEMENT     |                 |     5 |   185 |  2842   (2)| 00
:00:01 |                                                                        
                                                                                
|   1 |  HASH UNIQUE         |                 |     5 |   185 |  2842   (2)| 00
:00:01 |                                                                        
                                                                                
|*  2 |   HASH JOIN          |                 |   136K|  4944K|  2833   (1)| 00
:00:01 |                                                                        
                                                                                
|*  3 |    TABLE ACCESS FULL | MARKETING       |     5 |    30 |     3   (0)| 00
:00:01 |                                                                        
                                                                                
|*  4 |    HASH JOIN SEMI    |                 | 30411 |   920K|  2829   (1)| 00
:00:01 |                                                                        
                                                                                
|*  5 |     TABLE ACCESS FULL| CLIENT          | 30411 |   386K|   103   (1)| 00
:00:01 |                                                                        
                                                                                
|*  6 |     TABLE ACCESS FULL| IMMATRICULATION |   153K|  2698K|  2725   (1)| 00
:00:01 |                                                                        
                                                                                
--------------------------------------------------------------------------------
--------                                                                        
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   2 - access("CLIENT"."SEXE"="MARKETING"."SEXE")                               
   3 - filter("MARKETING"."SEXE"='M')                                           
   4 - access("IMMATRICULATION"."IMMATRICULATION"="CLIENT"."IMMATRICULATION")   
   5 - filter("CLIENT"."SEXE"='M')                                              
   6 - filter("IMMATRICULATION"."MARQUE"='Audi')                                
                                                                                
Note                                                                            
-----                                                                           
   - this is an adaptive plan                                                   


Statistiques
----------------------------------------------------------                      
         29  recursive calls                                                    
          0  db block gets                                                      
      10060  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
        639  bytes sent via SQL*Net to client                                   
        593  bytes received via SQL*Net from client                             
          2  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
          5  rows processed                                                     

SQL> -- SÃ©lectionner la couleur des Golf 2.0 FSI vendues Ã  des hommes
SQL> SELECT DISTINCT catalogue.couleur
  2  FROM catalogue
  3  JOIN immatriculation
  4  ON immatriculation.nom = catalogue.nom
  5  JOIN client
  6  ON client.immatriculation = immatriculation.immatriculation
  7  WHERE client.sexe='M' AND catalogue.nom = 'Golf 2.0 FSI';


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 720261464                                                      
                                                                                
--------------------------------------------------------------------------------
----------                                                                      
                                                                                
| Id  | Operation              | Name            | Rows  | Bytes | Cost (%CPU)| 
Time     |                                                                      
                                                                                
--------------------------------------------------------------------------------
----------                                                                      
                                                                                
|   0 | SELECT STATEMENT       |                 |     3 |   153 |  2839   (2)| 
00:00:01 |                                                                      
                                                                                
|   1 |  HASH UNIQUE           |                 |     3 |   153 |  2839   (2)| 
00:00:01 |                                                                      
                                                                                
|*  2 |   HASH JOIN            |                 |  3277 |   163K|  2838   (2)| 
00:00:01 |                                                                      
                                                                                
|   3 |    VIEW                | VW_DTP_AE567E71 |     3 |    51 |     4  (25)| 
00:00:01 |                                                                      
                                                                                
|   4 |     HASH UNIQUE        |                 |     3 |    51 |     4  (25)| 
00:00:01 |                                                                      
                                                                                
|*  5 |      TABLE ACCESS FULL | CATALOGUE       |    10 |   170 |     3   (0)| 
00:00:01 |                                                                      
                                                                                
|*  6 |    HASH JOIN RIGHT SEMI|                 | 30330 |  1007K|  2834   (2)| 
00:00:01 |                                                                      
                                                                                
|*  7 |     TABLE ACCESS FULL  | CLIENT          | 30411 |   386K|   103   (1)| 
00:00:01 |                                                                      
                                                                                
|   8 |     TABLE ACCESS FULL  | IMMATRICULATION |  1047K|    20M|  2722   (1)| 
00:00:01 |                                                                      
                                                                                
--------------------------------------------------------------------------------
----------                                                                      
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   2 - access("IMMATRICULATION"."NOM"="ITEM_1")                                 
   5 - filter("CATALOGUE"."NOM"='Golf 2.0 FSI')                                 
   6 - access("CLIENT"."IMMATRICULATION"="IMMATRICULATION"."IMMATRICULATION")   
   7 - filter("CLIENT"."SEXE"='M')                                              


Statistiques
----------------------------------------------------------                      
         95  recursive calls                                                    
          0  db block gets                                                      
      10078  consistent gets                                                    
          0  physical reads                                                     
          0  redo size                                                          
        649  bytes sent via SQL*Net to client                                   
        599  bytes received via SQL*Net from client                             
          2  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
          5  rows processed                                                     

SQL> -- SÃ©lectionner l'Ã¢ge des clients ayant achetÃ© une voiture rouge
SQL> SELECT DISTINCT client.age
  2  FROM client
  3  JOIN immatriculation
  4  ON client.immatriculation=immatriculation.immatriculation
  5  JOIN catalogue
  6  ON catalogue.marque=immatriculation.marque
  7  WHERE catalogue.couleur = 'rouge';

68 lignes sélectionnées.


Plan d'exécution
----------------------------------------------------------                      
Plan hash value: 3421959063                                                     
                                                                                
--------------------------------------------------------------------------------
---------                                                                       
                                                                                
| Id  | Operation             | Name            | Rows  | Bytes | Cost (%CPU)| T
ime     |                                                                       
                                                                                
--------------------------------------------------------------------------------
---------                                                                       
                                                                                
|   0 | SELECT STATEMENT      |                 |    67 |  3082 |  2839   (2)| 0
0:00:01 |                                                                       
                                                                                
|   1 |  HASH UNIQUE          |                 |    67 |  3082 |  2839   (2)| 0
0:00:01 |                                                                       
                                                                                
|*  2 |   HASH JOIN RIGHT SEMI|                 | 43596 |  1958K|  2836   (2)| 0
0:00:01 |                                                                       
                                                                                
|*  3 |    TABLE ACCESS FULL  | CATALOGUE       |    53 |   742 |     3   (0)| 0
0:00:01 |                                                                       
                                                                                
|*  4 |    HASH JOIN          |                 | 43596 |  1362K|  2832   (1)| 0
0:00:01 |                                                                       
                                                                                
|   5 |     TABLE ACCESS FULL | CLIENT          | 43596 |   596K|   103   (1)| 0
0:00:01 |                                                                       
                                                                                
|   6 |     TABLE ACCESS FULL | IMMATRICULATION |  1047K|    17M|  2721   (1)| 0
0:00:01 |                                                                       
                                                                                
--------------------------------------------------------------------------------
---------                                                                       
                                                                                
                                                                                
Predicate Information (identified by operation id):                             
---------------------------------------------------                             
                                                                                
   2 - access("CATALOGUE"."MARQUE"="IMMATRICULATION"."MARQUE")                  
   3 - filter("CATALOGUE"."COULEUR"='rouge')                                    
   4 - access("CLIENT"."IMMATRICULATION"="IMMATRICULATION"."IMMATRICULATION")   
                                                                                
Note                                                                            
-----                                                                           
   - this is an adaptive plan                                                   


Statistiques
----------------------------------------------------------                      
         92  recursive calls                                                    
          3  db block gets                                                      
      10080  consistent gets                                                    
          0  physical reads                                                     
        584  redo size                                                          
       1703  bytes sent via SQL*Net to client                                   
        615  bytes received via SQL*Net from client                             
          6  SQL*Net roundtrips to/from client                                  
          0  sorts (memory)                                                     
          0  sorts (disk)                                                       
         68  rows processed                                                     

SQL> 
SQL> set autotrace off
SQL> -- Connexion avec lau niveau CDB pour prendre un clich? AWR
SQL> -- La gestion des statistiques se fait au niveau e ma CDB
SQL> connect &MYCDBUSER@&DBALIASCDB/&MYCDBUSERPASS
Connecté.
SQL> 
SQL> -- Prendre un deuxi?me clich? AWR pour d?limiter
SQL> -- la fin de l'espace de r?cup?ration des requ?tes.
SQL> variable snapid2 number;
SQL> set serveroutput on
SQL> begin
  2  :snapid2 := dbms_workload_repository.create_snapshot;
  3  dbms_output.put_line('snap_id2='||:snapid2);
  4  end;
  5  /
snap_id2=1195                                                                   

Procédure PL/SQL terminée avec succès.

SQL> -- ReConnexion ? la PDB pour utiliser STA
SQL> connect &MYPDBUSER@&DBALIASPDB/&MYPDBUSERPASS
Connecté.
SQL> 
SQL> -- reporter le num?ro de clich? rendu par le programme ici :
SQL> -- snap_id2= 154 ? snap_id2=744
SQL> -- Supprimer la tache
SQL> -- Supprimer 1 tache TP_SQL_TUNING_TASK si elle existe d?j?
SQL> execute DBMS_SQLTUNE.DROP_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER');
BEGIN DBMS_SQLTUNE.DROP_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING'); END;

*
ERREUR à la ligne 1 :
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 3062 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 3046 
ORA-06512: à "SYS.DBMS_ADVISOR", ligne 193 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1289 
ORA-06512: à ligne 1 


SQL> execute DBMS_SQLTUNE.DROP_SQLSET('tp_sql_tuning_set'||'&MYPDBUSER');
BEGIN DBMS_SQLTUNE.DROP_SQLSET('tp_sql_tuning_set'||'PROJET_TUNING'); END;

*
ERREUR à la ligne 1 :
ORA-13754: L'"ensemble de réglages SQL" "tp_sql_tuning_setPROJET_TUNING" 
n'existe pas pour l'utilisateur "PROJET_TUNING". 
ORA-06512: à "SYS.DBMS_SQLTUNE_INTERNAL", ligne 14910 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 95 
ORA-06512: à "SYS.DBMS_SQLTUNE_UTIL1", ligne 491 
ORA-06512: à "SYS.DBMS_SQLTUNE_INTERNAL", ligne 14874 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 7315 
ORA-06512: à ligne 1 


SQL> -- Si vous avez d?j? ex?cut? ce script, il se peut qu'un
SQL> -- qu'un profile de requ?te ai d?j? ?t? cr??. Dans ce cas:
SQL> -- Rechercher puis supprimer le profie s'il existe d?j?
SQL> ---
SQL> set linesize 200
SQL> col sql_text format A40
SQL> select name
  2  from dba_sql_profiles
  3  order by name;

NAME                                                                                                                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------                                                                        
SYS_SQLPROF_0177d8ca8c750000                                                                                                                                                                            
SYS_SQLPROF_0177d8ccf5f10001                                                                                                                                                                            
SYS_SQLPROF_0177d8cfc4a10002                                                                                                                                                                            
SYS_SQLPROF_0177d8cfc4fe0003                                                                                                                                                                            
SYS_SQLPROF_0177d8cfc5550004                                                                                                                                                                            

SQL> -- Supprimer le(s) profile(s) s'ils ont ?t? trouv?s avec la requ?te
SQL> -- pr?c?dente. NomProfile est le r?sultat de la requ?te
SQL> -- ci-dessus. R?p?ter l'action si utile.
SQL> execute DBMS_SQLTUNE.DROP_SQL_PROFILE('NomProfile');
BEGIN DBMS_SQLTUNE.DROP_SQL_PROFILE('NomProfile'); END;

*
ERREUR à la ligne 1 :
ORA-13833: le patch ou le profil SQL nommé NomProfile n'existe pas 
ORA-06512: à "SYS.DBMS_SQLTUNE_INTERNAL", ligne 18804 
ORA-06512: à "SYS.PRVT_SQLPROF_INFRA", ligne 48 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 10999 
ORA-06512: à ligne 1 


SQL> -- 3. G?n?rer les recommandations
SQL> -- Ex?cuter le script ci-dessous pour optimiser automatiquement
SQL> -- les requ?tes lanc?es entre snap_id1 et snap_id2.
SQL> -- Le conseiller qui sera utilis? ici est SQL TUNNING ADVISOR.
SQL> set serveroutput on
SQL> DECLARE
  2  my_task_name VARCHAR2(30);
  3  nom_sqlset varchar2(50):='tp_sql_tuning_set'||'&MYPDBUSER';
  4  l_cursor DBMS_SQLTUNE.sqlset_cursor;
  5  BEGIN
  6  DBMS_SQLTUNE.CREATE_SQLSET(
  7  sqlset_name => nom_sqlset,
  8  description => 'I/O intensive workload');
  9  -- Appel de la fonction DBMS_SQLTUNE.select_workload_repository
 10  -- pour recolter les requ?tes ? r?gler automatiquement entre
 11  -- snap_id1 et snap_id2.
 12  -- remplacer snap_id1 et snap_id2 par les valeurs captur?es
 13  -- plus haut apr?s les appels de:dbms_workload_repository.create_snapshot;.
 14  --1059 et 1174
 15  OPEN l_cursor FOR
 16  SELECT VALUE(p)
 17  FROM TABLE (DBMS_SQLTUNE.select_workload_repository (
 18  :snapid1, --snap_id1, -- begin_snap :
 19  :snapid2, --snap_id2, -- end_snap
 20  'parsing_schema_name =''&MYPDBUSER'' and parsing_schema_name <> ''SYS''', -- basic_filter
 21  NULL, -- object_filter
 22  NULL, -- ranking_measure1
 23  NULL, -- ranking_measure2
 24  NULL, -- ranking_measure3
 25  NULL, -- result_percentage
 26  NULL, -- result_limit
 27  'ALL' -- attribute_list
 28  )
 29  -- 10) -- result_limit
 30  ) p;
 31  -- charger les requ?tes recolt?es entre snap_id1 et snap_id2
 32  -- actuellement pr?sente dans l_cursor dans le sql tuning
 33  -- set cr?? pr?c?demment.
 34  DBMS_SQLTUNE.load_sqlset (
 35  sqlset_name => nom_sqlset,
 36  populate_cursor => l_cursor);
 37  -- cr?er une t?che de tuning pour le sql tuning set
 38  -- aliment? en requ?te dans l'action ci-dessus.
 39  my_task_name := DBMS_SQLTUNE.CREATE_TUNING_TASK(
 40  sqlset_name => nom_sqlset,
 41  basic_filter => 'parsing_schema_name =''&MYPDBUSER''', -- basic_filter
 42  scope => 'COMPREHENSIVE',
 43  time_limit => 60,
 44  task_name => 'TP_SQL_TUNING_TASK'||'&MYPDBUSER',
 45  description => 'Task to tune a query on a specified bank queries'
 46  );
 47  -- Ex?cuter le t?che de tuning
 48  -- le conseiller utilis? ici est STA.
 49  --invocation du conseillÃ© grace Ã  la tache
 50  DBMS_SQLTUNE.EXECUTE_TUNING_TASK( task_name => my_task_name );
 51  END;
 52  /
ancien   3 : nom_sqlset varchar2(50):='tp_sql_tuning_set'||'&MYPDBUSER';
nouveau   3 : nom_sqlset varchar2(50):='tp_sql_tuning_set'||'PROJET_TUNING';
ancien  20 : 'parsing_schema_name =''&MYPDBUSER'' and parsing_schema_name <> ''SYS''', -- basic_filter
nouveau  20 : 'parsing_schema_name =''PROJET_TUNING'' and parsing_schema_name <> ''SYS''', -- basic_filter
ancien  41 : basic_filter => 'parsing_schema_name =''&MYPDBUSER''', -- basic_filter
nouveau  41 : basic_filter => 'parsing_schema_name =''PROJET_TUNING''', -- basic_filter
ancien  44 : task_name => 'TP_SQL_TUNING_TASK'||'&MYPDBUSER',
nouveau  44 : task_name => 'TP_SQL_TUNING_TASK'||'PROJET_TUNING',
DECLARE
*
ERREUR à la ligne 1 :
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.DBMS_SQLTUNE_INTERNAL", ligne 9405 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6086 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 1843 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7095 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 1616 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6048 
ORA-06512: à "SYS.DBMS_SQLTUNE_INTERNAL", ligne 9268 
ORA-06512: à "SYS.PRVT_SQLADV_INFRA", ligne 621 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 890 
ORA-06512: à ligne 39 


SQL> 
SQL> -- 4. Afficher les r?sultats d'analyses
SQL> -- Consultation des informations sur la tache
SQL> -- V?rification de la t?che cr??e
SQL> col task_name format a20
SQL> SELECT task_name
  2  FROM DBA_ADVISOR_LOG
  3  WHERE owner ='&MYPDBUSER' and task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER';
ancien   3 : WHERE owner ='&MYPDBUSER' and task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   3 : WHERE owner ='PROJET_TUNING' and task_name='TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> --?
SQL> -- La vue Advisor_tasks contient des informations
SQL> -- sur les t?ches
SQL> SELECT TASK_NAME, ADVISOR_NAME, status , RECOMMENDATION_COUNT, SOURCE
  2  FROM USER_ADVISOR_TASKS
  3  WHERE task_name = 'TP_SQL_TUNING_TASK'||'&MYPDBUSER';
ancien   3 : WHERE task_name = 'TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   3 : WHERE task_name = 'TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> --?
SQL> -- La vue V$ADVISOR_PROGRESS contient des informations
SQL> -- sur la progression des t?ches
SQL> -- Exemple de consultation de la progression
SQL> SELECT sofar, totalwork FROM
  2  V$ADVISOR_PROGRESS vp,
  3  DBA_ADVISOR_LOG da
  4  WHERE vp.username = '&MYPDBUSER'
  5  AND vp.task_id=da.task_id
  6  AND da.task_name = 'TP_SQL_TUNING_TASK'||'&MYPDBUSER';
ancien   4 : WHERE vp.username = '&MYPDBUSER'
nouveau   4 : WHERE vp.username = 'PROJET_TUNING'
ancien   6 : AND da.task_name = 'TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   6 : AND da.task_name = 'TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> --?
SQL> --La fonction DBMS_SQLTUNE.REPORT_TUNING_TASK permet d'afficher
SQL> --le r?sultat d'une analyse
SQL> 
SQL> SET LONG 4000
SQL> SET LONGCHUNKSIZE 4000
SQL> SET LINESIZE 200
SQL> SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK( 'TP_SQL_TUNING_TASK'||'&MYPDBUSER')
  2  FROM DUAL;
ancien   1 : SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK( 'TP_SQL_TUNING_TASK'||'&MYPDBUSER')
nouveau   1 : SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK( 'TP_SQL_TUNING_TASK'||'PROJET_TUNING')
ERROR:
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1359 
ORA-06512: à ligne 1 



aucune ligne sélectionnée

SQL> 
SQL> --?
SQL> -- r?sultat du report il est conseill?e de restructurer la
SQL> -- requ?te.
SQL> --?
SQL> -- la ligne ci-dessous dans le rapport indique qu'il y'a une
SQL> -- restructuration de la requete ? faire.
SQL> -- Number of SQL Restructure Findings: 1
SQL> --
SQL> -- Type de recommandation
SQL> -- Consulter le type de recommandation dans la vue
SQL> -- DBA_ADVISOR_RECOMMENDATIONS
SQL> --
SQL> col task_name format A20
SQL> col PARENT_REC_IDS format A40
SQL> col vs.SQL_TEXT format a60
SQL> col reco_type format A20
SQL> set linesize 200
SQL> set pagesize 400
SQL> 
SQL> select distinct dar.task_name, vs.sql_id, vs.SQL_TEXT, dar.type reco_type , BENEFIT
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_RECOMMENDATIONS dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
  8  and sql_text not like '%EXPLAIN%'
  9  and sql_text not like '%opt_param%'
 10  and sql_text not like '%insert%'
 11  and sql_text not like '%V_$SESSTAT%'
 12  and sql_text not like '%PLAN_TABLE%'
 13  order by dar.task_name, vs.sql_id, reco_type;
ancien   7 : and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   7 : and dar.task_name='TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> 
SQL> --?
SQL> --
SQL> -- Consultation la description du probl?me trouv? par STA
SQL> -- Dans la vue DBA_ADVISOR_FINDINGS
SQL> -- R?sultation de la recherche
SQL> ---
SQL> col task_name format A10
SQL> col message format A40
SQL> col more_info format A40
SQL> col impact_type format A40
SQL> col vs.SQL_TEXT format a40
SQL> set linesize 300
SQL> set pagesize 400
SQL> select distinct dar.task_name, da.object_id, vs.sql_id, vs.SQL_TEXT, MESSAGE, impact_type, more_info
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_FINDINGS dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and da.object_id=dar.object_id
  8  and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
  9  and sql_text not like '%EXPLAIN%'
 10  and sql_text not like '%opt_param%'
 11  and sql_text not like '%insert%'
 12  and sql_text not like '%V_$SESSTAT%'
 13  and sql_text not like '%PLAN_TABLE%'
 14  order by dar.task_name, da.object_id, vs.sql_id;
ancien   8 : and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   8 : and dar.task_name='TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> --?
SQL> ---
SQL> --- recommandation
SQL> --- consulter les actions (diagnostic) recommand?es par STA
SQL> --- dans la vue DBA_ADVISOR_ACTIONS
SQL> ---
SQL> -- voir
SQL> col task_name format A20
SQL> col message format A40
SQL> col more_info format A40
SQL> col impact_type format A40
SQL> col SQL_TEXT format a40
SQL> set linesize 200
SQL> set pagesize 400
SQL> 
SQL> select distinct dar.task_name, da.object_id, vs.sql_id, vs.SQL_TEXT, message
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_ACTIONS dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and da.object_id=dar.object_id
  8  and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
  9  and sql_text not like '%EXPLAIN%'
 10  and sql_text not like '%opt_param%'
 11  and sql_text not like '%insert%'
 12  and sql_text not like '%V_$SESSTAT%'
 13  and sql_text not like '%PLAN_TABLE%'
 14  order by dar.task_name, da.object_id, vs.sql_id;
ancien   8 : and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   8 : and dar.task_name='TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> --?
SQL> 
SQL> -- Liste des actions possibles
SQL> set linesize 200
SQL> col ATTR1 format a30
SQL> col ATTR2 format a10
SQL> col attr3 format a20
SQL> col ATTR4 format a10
SQL> col attr5 format a30
SQL> select
  2  object_id,
  3  ATTR1,
  4  ATTR2,
  5  ATTR3,
  6  ATTR4,
  7  ATTR5
  8  from DBA_ADVISOR_ACTIONS
  9  where attr1 like '&MYPDBUSER'||'%'
 10  order by object_id;
ancien   9 : where attr1 like '&MYPDBUSER'||'%'
nouveau   9 : where attr1 like 'PROJET_TUNING'||'%'

aucune ligne sélectionnée

SQL> 
SQL> ---
SQL> --- Raisonnement
SQL> --- Raisonnement avec des explications compl?mentaires sur
SQL> --- le probl?me.
SQL> --- Consult? pour cela la vue DBA_ADVISOR_RATIONALE
SQL> ---
SQL> 
SQL> col task_name format A20
SQL> col message format A40
SQL> col more_info format A40
SQL> col impact_type format A40
SQL> col SQL_TEXT format a40
SQL> set linesize 200
SQL> set pagesize 400
SQL> 
SQL> select distinct dar.task_name, da.object_id, vs.sql_id, vs.SQL_TEXT, message
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_RATIONALE dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and da.object_id=dar.object_id
  8  and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
  9  and sql_text not like '%EXPLAIN%'
 10  and sql_text not like '%opt_param%'
 11  and sql_text not like '%insert%'
 12  and sql_text not like '%V_$SESSTAT%'
 13  and sql_text not like '%PLAN_TABLE%'
 14  order by dar.task_name, da.object_id, vs.sql_id;
ancien   8 : and dar.task_name='TP_SQL_TUNING_TASK'||'&MYPDBUSER'
nouveau   8 : and dar.task_name='TP_SQL_TUNING_TASK'||'PROJET_TUNING'

aucune ligne sélectionnée

SQL> --?
SQL> 
SQL> --
SQL> -- Rechercher s'il y'a des scripts g?n?r?s
SQL> -- Identifier s'il ya un profile pour cette requ?te choisie plus
SQL> -- haut.
SQL> -- afficher le script complet ou partiel
SQL> col myscript format a1000
SQL> set long 4000
SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL') MYSCRIPT from dual;
ancien   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL') MYSCRIPT from dual
nouveau   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING', 'ALL') MYSCRIPT from dual
ERROR:
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1806 
ORA-06512: à ligne 1 



aucune ligne sélectionnée

SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'INDEXES') MYSCRIPT from dual;
ancien   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'INDEXES') MYSCRIPT from dual
nouveau   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING', 'INDEXES') MYSCRIPT from dual
ERROR:
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1806 
ORA-06512: à ligne 1 



aucune ligne sélectionnée

SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'PROFILES') MYSCRIPT from dual;
ancien   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'PROFILES') MYSCRIPT from dual
nouveau   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING', 'PROFILES') MYSCRIPT from dual
ERROR:
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1806 
ORA-06512: à ligne 1 



aucune ligne sélectionnée

SQL> â[18:54] Alphonse FOURNIER
SP2-0734: commande inconnue au début de "â[18:54]..." - le reste de la ligne est ignoré.
SQL> 
SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'STATISTICS') MYSCRIPT from dual;
ancien   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'STATISTICS') MYSCRIPT from dual
nouveau   1 : select dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING', 'STATISTICS') MYSCRIPT from dual
ERROR:
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1806 
ORA-06512: à ligne 1 



aucune ligne sélectionnée

SQL> -- une autre fa?on d'afficher le script complet
SQL> set serveroutput on
SQL> begin
  2  dbms_output.put_line(dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL'));
  3  end;
  4  /
ancien   2 : dbms_output.put_line(dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL'));
nouveau   2 : dbms_output.put_line(dbms_sqltune.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING', 'ALL'));
begin
*
ERREUR à la ligne 1 :
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1806 
ORA-06512: à ligne 2 


SQL> --?
SQL> -- 5. G?rer le script SQL propos? pour le r?glage SQL
SQL> -- G?rer le script SQL propos? pour le r?glage SQL : Attention ce script est disponible dans le dossier %ORACLE_BASE%\admin\dpdump
SQL> -- r?cup?rer le script et le mettre dans votre dossier : EXO91
SQL> -- Editer ce script de fa?on appropri?
SQL> declare
  2  mydate varchar2(20):=to_char(sysdate, 'DD_MM_YYYY_HH24_MI_SS');
  3  fname varchar2(300):='STA_Generate_action_script_on_TuningProject'
  4  ||'&MYPDBUSER'|| '_'||mydate||'.sql';
  5  begin
  6  DBMS_ADVISOR.CREATE_FILE(
  7  DBMS_SQLTUNE.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER'),
  8  'DATA_PUMP_DIR',
  9  fname
 10  );
 11  end;
 12  /
ancien   4 : ||'&MYPDBUSER'|| '_'||mydate||'.sql';
nouveau   4 : ||'PROJET_TUNING'|| '_'||mydate||'.sql';
ancien   7 : DBMS_SQLTUNE.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'&MYPDBUSER'),
nouveau   7 : DBMS_SQLTUNE.SCRIPT_TUNING_TASK('TP_SQL_TUNING_TASK'||'PROJET_TUNING'),
declare
*
ERREUR à la ligne 1 :
ORA-13608: Le nom indiqué, TP_SQL_TUNING_TASKPROJET_TU..., n'est pas valide. 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7285 
ORA-06512: à "SYS.DBMS_SYS_ERROR", ligne 86 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 68 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 6145 
ORA-06512: à "SYS.PRVT_ADVISOR", ligne 7215 
ORA-06512: à "SYS.DBMS_SQLTUNE", ligne 1806 
ORA-06512: à ligne 6 


SQL> -- ex?cuter le script pour accepter le profile de la requ?te choisie
SQL> -- execute dbms_sqltune.accept_sql_profile(task_name => 'TP_SQL_TUNING_TASK'||'&MYPDBUSER', replace => TRUE);
SQL> ---
SQL> --- V?rifier la pr?sence d'un profie dans la vue
SQL> ---
SQL> set linesize 200
SQL> col sql_text format A40
SQL> select name ,CATEGORY, SQL_TEXT , STATUS,FORCE_MATCHING
  2  from dba_sql_profiles
  3  order by name;

NAME                                                                                                                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------                                                                        
CATEGORY                                                                                                                         SQL_TEXT                                 STATUS   FOR                  
-------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------- -------- ---                  
SYS_SQLPROF_0177d8ca8c750000                                                                                                                                                                            
DEFAULT                                                                                                                           select co.typecompte,  operation, sum(m ENABLED  NO                   
                                                                                                                                 ontant)                                                                
                                                                                                                                  from client cl, compte co, transaction                                
                                                                                                                                 tr                                                                     
                                                                                                                                  where cl.clientid=co.clientid and co.co                               
                                                                                                                                 mpteid=tr.compteid                                                     
                                                                                                                                  and tr.date_operation                                                 
                                                                                                                                  between to_date('25-01-2010', 'DD-MM-YY                               
                                                                                                                                 YY') and to_date('27-01-2010', 'DD-MM-YY                               
                                                                                                                                 YY')                                                                   
                                                                                                                                  group by co.typecompte,  operation                                    
                                                                                                                                                                                                        
SYS_SQLPROF_0177d8ccf5f10001                                                                                                                                                                            
DEFAULT                                                                                                                          EXPLAIN PLAN SET STATEMENT_ID='PLUS10000 ENABLED  NO                   
                                                                                                                                 4' FOR  select cl.clientid, nom, prenom,                               
                                                                                                                                  co.compteid, co.typecompte, tr.date_ope                               
                                                                                                                                 ration,  operation,                                                    
                                                                                                                                  optionoperation, montant                                              
                                                                                                                                  from client cl, compte co, transaction                                
                                                                                                                                 tr                                                                     
                                                                                                                                  where cl.clientid=co.clientid and co.co                               
                                                                                                                                 mpteid=tr.compteid                                                     
                                                                                                                                  and co.solde <0                                                       
                                                                                                                                                                                                        
SYS_SQLPROF_0177d8cfc4a10002                                                                                                                                                                            
DEFAULT                                                                                                                          EXPLAIN PLAN SET STATEMENT_ID='PLUS10000 ENABLED  NO                   
                                                                                                                                 7' FOR   select cl.clientid,  co.comptei                               
                                                                                                                                 d, operation, sum(montant)                                             
                                                                                                                                  from client cl, compte co, transaction                                
                                                                                                                                 tr                                                                     
                                                                                                                                  where cl.clientid=co.clientid and co.co                               
                                                                                                                                 mpteid=tr.compteid                                                     
                                                                                                                                  group by cl.clientid,  co.compteid, ope                               
                                                                                                                                 ration                                                                 
                                                                                                                                                                                                        
SYS_SQLPROF_0177d8cfc4fe0003                                                                                                                                                                            
DEFAULT                                                                                                                          EXPLAIN PLAN SET STATEMENT_ID='PLUS10000 ENABLED  NO                   
                                                                                                                                 7' FOR  select cl.clientid, nom, prenom,                               
                                                                                                                                  co.compteid, co.typecompte, tr.date_ope                               
                                                                                                                                 ration,  operation,                                                    
                                                                                                                                  optionoperation, montant                                              
                                                                                                                                  from client cl, compte co, transaction                                
                                                                                                                                 tr                                                                     
                                                                                                                                  where cl.clientid=co.clientid and co.co                               
                                                                                                                                 mpteid=tr.compteid                                                     
                                                                                                                                  and cl.nom='Petit' and operation='DEBIT                               
                                                                                                                                 '                                                                      
                                                                                                                                                                                                        
SYS_SQLPROF_0177d8cfc5550004                                                                                                                                                                            
DEFAULT                                                                                                                          EXPLAIN PLAN SET STATEMENT_ID='PLUS10000 ENABLED  NO                   
                                                                                                                                 7' FOR  select cl.clientid, nom, prenom,                               
                                                                                                                                  co.compteid, co.typecompte, tr.date_ope                               
                                                                                                                                 ration,  operation,                                                    
                                                                                                                                  optionoperation, montant                                              
                                                                                                                                  from client cl, compte co, transaction                                
                                                                                                                                 tr                                                                     
                                                                                                                                  where cl.clientid=co.clientid and co.co                               
                                                                                                                                 mpteid=tr.compteid                                                     
                                                                                                                                  and cl.nom='Petit'                                                    
                                                                                                                                                                                                        

SQL> 
SQL> SPOOL OFF
